<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="How to implement a (basic) probabilistic programming language in Julia">

<title>mysite - PPL from scratch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">mysite</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">My Notes</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">PPL from scratch</h1>
                  <div>
        <div class="description">
          How to implement a (basic) probabilistic programming language in Julia
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">julia, Bayes</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#bayes-theorem" id="toc-bayes-theorem" class="nav-link active" data-scroll-target="#bayes-theorem">Bayes’ theorem</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#approximating-the-posterior" id="toc-approximating-the-posterior" class="nav-link" data-scroll-target="#approximating-the-posterior">Approximating the posterior</a>
  <ul class="collapse">
  <li><a href="#grid-approximation" id="toc-grid-approximation" class="nav-link" data-scroll-target="#grid-approximation">Grid approximation</a></li>
  <li><a href="#markov-chain-monte-carlo" id="toc-markov-chain-monte-carlo" class="nav-link" data-scroll-target="#markov-chain-monte-carlo">Markov-chain Monte Carlo</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><img src="bayes.jpeg" class="img-fluid" width="600"></p>
<section id="bayes-theorem" class="level2">
<h2 class="anchored" data-anchor-id="bayes-theorem">Bayes’ theorem</h2>
<p>The <em>conditional probability</em> of an event <span class="math inline">\(A\)</span> given an event <span class="math inline">\(B\)</span> is given as</p>
<p><span class="math display">\[
P(A|B) = \frac{P(A,B)}{P(B)}
\]</span></p>
<p>The <em>joint probability</em> <span class="math inline">\(P(A, B)\)</span> of events <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> can, therefore, be expressed in two ways as <span class="math display">\[
P(A,B) = P(A|B)P(B) = P(B|A)P(A)
\]</span></p>
<p>This leads to <em>Bayes’ theorem</em> <span class="math display">\[
P(A|B) = \frac{P(B|A)P(A)}{P(B)}
\]</span></p>
<p>Bayes’ theorem lets us express the conditional probability <span class="math inline">\(P(A|B)\)</span> through <span class="math inline">\(P(B|A)\)</span>.</p>
<p>Say we have a model <span class="math inline">\(M\)</span> that describes how data <span class="math inline">\(D\)</span> is generated based on some parameterization <span class="math inline">\(\Theta\)</span> of the model. Let’s assume that we can express the model through a probability distribution <span class="math inline">\(P(D|\Theta, M)\)</span>. Before looking at the data, we might have some prior belief about the parameters <span class="math inline">\(\Theta\)</span>, which can be expressed by a probability function <span class="math inline">\(P(\Theta)\)</span>, the so-called <em>prior distribution</em>. After observing the data <span class="math inline">\(D\)</span>, we can then update our belief by using Bayes’ theorem</p>
<p><span class="math display">\[
P(\Theta|D, M) = \frac{P(D|\Theta, M)P(\Theta|M)}{P(D|M)}
\]</span></p>
<p>The updated belief in light of the observed data <span class="math inline">\(D\)</span> is called the <em>posterior distribution</em>.</p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The purpose of probabilistic programming is to provide an easy way for inference of latent variables from observed data. This can be done using sampling (MCMC) or variational inference.</p>
<p>Probabilistic programs are usual functional or imperative programs with two added constructs [Gordon2014]</p>
<ul>
<li>assume/sample: draw values at random from distributions or replay</li>
<li>observe/condition: condition values of variables in a program via observations</li>
</ul>
<p>Instead of providing the posterior/joint probability/likelihood in functional form, they allow to provide a model that generates samples (by sampling from distributions).</p>
<p>Say program generates output <span class="math inline">\(y\)</span> based on draws of latent variables <span class="math inline">\(x\)</span>. The chosen <span class="math inline">\(x\)</span> are called the trace of the program. Given some observations <span class="math inline">\(y\)</span>, we want to draw inferences about which <span class="math inline">\(x\)</span> have been used to generate the observed <span class="math inline">\(y\)</span>, i.e.&nbsp;we want to infer <span class="math inline">\(P(x|y)\)</span>.</p>
<p>A probabilistic program is a function consisting of a mix of stochastic and deterministic elements.</p>
<div id="04720667" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsBase</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="668836ce" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">plot prior, likelihood and posterior for BetaBinomial(α, β, y, n)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_beta_binomial</span>(α, β, y, n)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">range</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>; length <span class="op">=</span> <span class="fl">1000</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    prior <span class="op">=</span> <span class="fu">pdf</span>.(<span class="fu">Beta</span>(α, β), x)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    likelihood <span class="op">=</span> <span class="fu">pdf</span>.(<span class="fu">Binomial</span>.(n, x), y)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    scaling <span class="op">=</span> <span class="fu">sum</span>(likelihood) <span class="op">/</span> <span class="fl">1000</span>.</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    likelihood <span class="op">./=</span> scaling</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    posterior <span class="op">=</span> <span class="fu">pdf</span>.(<span class="fu">Beta</span>(α <span class="op">+</span> y, β <span class="op">+</span> (n <span class="op">-</span> y)), x)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    f,a,p <span class="op">=</span> <span class="fu">poly</span>(<span class="fu">Point2</span>.(x, prior); color <span class="op">=</span> (<span class="op">:</span>yellow, <span class="fl">0.3</span>), label <span class="op">=</span> <span class="st">"Prior"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>         axis <span class="op">=</span> (;title <span class="op">=</span> <span class="st">"BetaBinomial(α = </span><span class="sc">$</span>(α)<span class="st">, β = </span><span class="sc">$</span>(β)<span class="st">, y = </span><span class="sc">$</span>(y)<span class="st">, n = </span><span class="sc">$</span>(n)<span class="st">)"</span>, xlabel <span class="op">=</span> <span class="st">"π"</span>, ylabel <span class="op">=</span> <span class="st">"f(π)"</span>))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly!</span>(a, <span class="fu">Point2</span>.(x, likelihood); color <span class="op">=</span> (<span class="op">:</span>red, <span class="fl">0.3</span>), label <span class="op">=</span> <span class="st">"Likelihood"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">poly!</span>(a, <span class="fu">Point2</span>.(x, posterior); color <span class="op">=</span> (<span class="op">:</span>green, <span class="fl">0.3</span>), label <span class="op">=</span> <span class="st">"Posterior"</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(a)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    f</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_beta_binomial</span>(<span class="fl">45</span>, <span class="fl">55</span>, <span class="fl">30</span>, <span class="fl">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>┌ Warning: Found `resolution` in the theme when creating a `Scene`. The `resolution` keyword for `Scene`s and `Figure`s has been deprecated. Use `Figure(; size = ...` or `Scene(; size = ...)` instead, which better reflects that this is a unitless size and not a pixel resolution. The key could also come from `set_theme!` calls or related theming functions.
└ @ Makie ~/.julia/packages/Makie/iRM0c/src/scenes.jl:220</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-3-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="approximating-the-posterior" class="level2">
<h2 class="anchored" data-anchor-id="approximating-the-posterior">Approximating the posterior</h2>
<section id="grid-approximation" class="level3">
<h3 class="anchored" data-anchor-id="grid-approximation">Grid approximation</h3>
<p>Want to get a sample of posterior <span class="math inline">\(f(\Theta | y)\)</span> given prior and likelihood</p>
<ol type="1">
<li>Define grid of possible <span class="math inline">\(\Theta\)</span> values</li>
<li>Evaluate prior <span class="math inline">\(p(\Theta)\)</span> and likelihood <span class="math inline">\(L(\Theta|y)\)</span> at those values</li>
<li>Obtain discrete approximation of posterior by
<ul>
<li>computing product <span class="math inline">\(p(\Theta) L(\Theta|y)\)</span> at all grid values</li>
<li>normalizing their sum to 1</li>
</ul></li>
<li>Randomly sample from grid values using discrete posterior as weights</li>
</ol>
<div id="adb7f921" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">pdf</span>(<span class="fu">Beta</span>(<span class="fl">45</span>, <span class="fl">55</span>), <span class="cn">π</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">likelihood</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">pdf</span>(<span class="fu">Binomial</span>(<span class="fl">50</span>, <span class="cn">π</span>), <span class="fl">30</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">DataFrame</span>(<span class="cn">π</span> <span class="op">=</span> <span class="fu">range</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>; length <span class="op">=</span> <span class="fl">100</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df.prior <span class="op">=</span> <span class="fu">prior</span>.(df.<span class="cn">π</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>df.likelihood <span class="op">=</span> <span class="fu">likelihood</span>.(df.<span class="cn">π</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>df.posterior <span class="op">=</span> df.prior <span class="op">.*</span> df.likelihood</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>df.posterior <span class="op">=</span> df.posterior <span class="op">/</span> <span class="fu">sum</span>(df.posterior)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="fu">sample</span>(df.<span class="cn">π</span>, <span class="fu">Weights</span>(df.posterior), <span class="fl">10000</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>f, a, p <span class="op">=</span> <span class="fu">density</span>(s; axis <span class="op">=</span> (;xlabel <span class="op">=</span> <span class="st">"π"</span>, ylabel <span class="op">=</span> <span class="st">"P(π)"</span>), </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                  label <span class="op">=</span> <span class="st">"simulation"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines!</span>(a, df.<span class="cn">π</span>, <span class="fu">pdf</span>.(<span class="fu">Beta</span>(<span class="fl">75</span>, <span class="fl">75</span>), df.<span class="cn">π</span>); </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>       label <span class="op">=</span> <span class="st">"theoretical"</span>, linewidth <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>┌ Warning: Found `resolution` in the theme when creating a `Scene`. The `resolution` keyword for `Scene`s and `Figure`s has been deprecated. Use `Figure(; size = ...` or `Scene(; size = ...)` instead, which better reflects that this is a unitless size and not a pixel resolution. The key could also come from `set_theme!` calls or related theming functions.
└ @ Makie ~/.julia/packages/Makie/iRM0c/src/scenes.jl:220</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-4-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While this works for low dimensions, the number of grid points grows exponentially with the number of dimensions.</p>
<p>If we knew the posterior probability, we could sample from it.</p>
<p>The posterior probability is proportional to the product of the prior and the likelihood, two functions which we know. What we do not know is the normalization constant that ensures that the posterior probability integrates to 1.</p>
<p>In the grid approximation above we normalized the posterior by summing over all grid points. But as we saw above, this becomes impossible for high dimensional parameter spaces.</p>
</section>
<section id="markov-chain-monte-carlo" class="level3">
<h3 class="anchored" data-anchor-id="markov-chain-monte-carlo">Markov-chain Monte Carlo</h3>
<p>Markov-chain Monte Carlo (MCMC) is a method to sample from (unnormalized) probability distributions.</p>
<p>Assume we have a system with <span class="math inline">\(n\)</span> states, together with a probabilistic rule that specifies how the system moves from the current state <span class="math inline">\(s(t)\)</span> to a new state <span class="math inline">\(s(t+1)\)</span>, where <span class="math inline">\(t\)</span> designates the discrete time.</p>
<p>This rule can be specified using a so-called transition matrix <span class="math inline">\(T_{ij}\)</span> that gives the probability to transition from state <span class="math inline">\(i\)</span> to state <span class="math inline">\(j\)</span>. The probability to move to state <span class="math inline">\(j\)</span> at time <span class="math inline">\(t+1\)</span> only depends on the current state at time <span class="math inline">\(t\)</span>, and is independent of the previous history. Such a system is called a first-order Markov chain.</p>
<p>As the system needs to end in one of the available states, we have</p>
<p><span class="math display">\[
\sum_j T_{ij} = 1
\]</span></p>
<p>Let <span class="math inline">\(\pi_i^t\)</span> be the probability to be in some state <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>. The probability to end in state <span class="math inline">\(j\)</span> at time <span class="math inline">\(t+1\)</span> is then</p>
<p><span class="math display">\[
\pi_j^{t+1} = \sum_i \pi_i^t T_{ij}
\]</span></p>
<p>If a condition called <strong>detailed balance</strong> holds,</p>
<p><span class="math display">\[
\pi_i T_{ij} = \pi_j T_{ji}
\]</span></p>
<p>then we have</p>
<p><span class="math display">\[
\pi_j^{t+1} = \sum_i \pi_i^{t} T_{ij} = \sum_i \pi_j^{t} T_{ji} = \pi_j^{t} \sum_i T_{ji} = \pi_j^{t}
\]</span></p>
<p>i.e.&nbsp;the chain is stationary</p>
<p>In the <strong>Metropolis-Hastings</strong> algorithm, the transition probability <span class="math inline">\(T_{ij}\)</span> is decomposed into a proposal probability <span class="math inline">\(P_{ij}\)</span> and an acceptance probability <span class="math inline">\(A_{ij}\)</span></p>
<p><span class="math display">\[
T_{ij} = P_{ij} A_{ij}
\]</span></p>
<p>The condition for detailed balance thus becomes</p>
<p><span class="math display">\[
\pi_i P_{ij} A_{ij} = \pi_j P_{ji} A_{ji}
\]</span></p>
<p>or</p>
<p><span class="math display">\[
\frac{A_{ij}}{A_{ji}} = \frac{\pi_j P_{ji}}{\pi_i P_{ij}}
\]</span></p>
<p>This condition can be fulfilled by choosing</p>
<p><span class="math display">\[
A_{ij} = \min \left( \frac{\pi_j P_{ji}}{\pi_i P_{ij}}, 1 \right)
\]</span></p>
<p><strong>Metropolis-Hastings</strong> algorithm:</p>
<p>Given prior <span class="math inline">\(P(\Theta)\)</span> and likelihood <span class="math inline">\(L(\Theta|y)\)</span>, want to draw samples from posterior</p>
<ul>
<li>Draw <span class="math inline">\(\Theta^1\)</span> from prior</li>
<li>for t = 1 .. N
<ul>
<li>propose a new <span class="math inline">\(\Theta'\)</span> by drawing from proposal probability <span class="math inline">\(Q(\Theta'|\Theta^t)\)</span></li>
<li>compute acceptance probability <span class="math inline">\(A\)</span> <span class="math display">\[
A = \min \left(\frac{P(\Theta')L(\Theta'|y) Q(\Theta^t|\Theta')}{P(\Theta^t)L(\Theta^t|y) Q(\Theta'|\Theta^t)}, 1 \right)
\]</span></li>
<li>set <span class="math inline">\(\Theta^{t+1} = \Theta'\)</span> with probability <span class="math inline">\(A\)</span>, otherwise set <span class="math inline">\(\Theta^{t+1} = \Theta^t\)</span></li>
</ul></li>
</ul>
<p>In the <strong>Metropolis</strong> algorithm, the proposal probability is taken to be symmetric, i.e.&nbsp; <span class="math display">\[
Q(\Theta'|\Theta^t) = Q(\Theta^t|\Theta')
\]</span></p>
<p>In the <strong>independence sampling</strong> algorithm, the proposal is independent of the current state, i.e.&nbsp; <span class="math display">\[
Q(\Theta'|\Theta^t) = Q(\Theta')
\]</span> and <span class="math display">\[
Q(\Theta^t|\Theta') = Q(\Theta^t)
\]</span></p>
<section id="beta-binomial-problem-using-independence-sampling" class="level4">
<h4 class="anchored" data-anchor-id="beta-binomial-problem-using-independence-sampling">Beta-binomial problem using independence sampling</h4>
<p>Here we solve the Beta-Binomial problem using independence sampling.</p>
<div id="870948f8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># solve Beta-Binomial problem using independence sampling</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">logprior</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">45</span>, <span class="fl">55</span>), <span class="cn">π</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">loglik</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Binomial</span>(<span class="fl">50</span>, <span class="cn">π</span>), <span class="fl">30</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">randproposal</span>(Θ_c) <span class="op">=</span> <span class="fu">rand</span>(<span class="fu">Beta</span>(<span class="fl">2</span>,<span class="fl">2</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">logproposal</span>(Θ, Θ_c) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">2</span>,<span class="fl">2</span>), Θ)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">metropolis_hastings</span>(logprior, loglik, initial, randproposal, logproposal, n)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> initial</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    samples <span class="op">=</span> [current]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    accepted <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        proposed <span class="op">=</span> <span class="fu">randproposal</span>(current)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        lp_current <span class="op">=</span> <span class="fu">logprior</span>(current) <span class="op">+</span> <span class="fu">loglik</span>(current) <span class="op">+</span> <span class="fu">logproposal</span>(proposed, current) </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        lp_proposed <span class="op">=</span> <span class="fu">logprior</span>(proposed) <span class="op">+</span> <span class="fu">loglik</span>(proposed) <span class="op">+</span> <span class="fu">logproposal</span>(current, proposed)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        Δ <span class="op">=</span> lp_proposed <span class="op">-</span> lp_current</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Δ <span class="op">&gt;</span> <span class="fl">0.0</span> <span class="op">||</span> <span class="fu">rand</span>() <span class="op">&lt;</span> <span class="fu">exp</span>(Δ)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            current <span class="op">=</span> proposed</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            accepted <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(samples, current)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Acceptance ratio:"</span>, accepted<span class="op">/</span>n)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    samples</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>metropolis_hastings (generic function with 1 method)</code></pre>
</div>
</div>
<div id="f5ad58ec" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> samples <span class="op">=</span> <span class="fu">metropolis_hastings</span>(logprior, loglik, <span class="fl">0.5</span>, randproposal, logproposal, <span class="fl">10_000</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Acceptance ratio:0.1933
  0.022623 seconds (37.44 k allocations: 3.380 MiB, 85.85% compilation time)</code></pre>
</div>
</div>
<div id="1165215d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="fu">Figure</span>(;size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ax1, plt1 <span class="op">=</span> <span class="fu">density</span>(f[<span class="fl">1</span>,<span class="fl">2</span>], samples; axis <span class="op">=</span> (;title <span class="op">=</span> <span class="st">"Density"</span>, xlabel <span class="op">=</span> <span class="st">"π"</span>, ylabel <span class="op">=</span> <span class="st">"P(π)"</span>), label <span class="op">=</span> <span class="st">"simulation"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines!</span>(ax1, df.<span class="cn">π</span>, <span class="fu">pdf</span>.(<span class="fu">Beta</span>(<span class="fl">75</span>, <span class="fl">75</span>), df.<span class="cn">π</span>); label <span class="op">=</span> <span class="st">"theoretical"</span>, linewidth <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax1)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ax2, plt2 <span class="op">=</span> <span class="fu">lines</span>(f[<span class="fl">1</span>,<span class="fl">1</span>], samples; alpha <span class="op">=</span> <span class="fl">0.4</span>, axis <span class="op">=</span> (;title <span class="op">=</span> <span class="st">"Traceplot"</span>, xlabel <span class="op">=</span> <span class="st">"Samples"</span>, ylabel <span class="op">=</span> <span class="st">"π"</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>┌ Warning: Found `resolution` in the theme when creating a `Scene`. The `resolution` keyword for `Scene`s and `Figure`s has been deprecated. Use `Figure(; size = ...` or `Scene(; size = ...)` instead, which better reflects that this is a unitless size and not a pixel resolution. The key could also come from `set_theme!` calls or related theming functions.
└ @ Makie ~/.julia/packages/Makie/iRM0c/src/scenes.jl:220</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-7-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="beta-binomial-problem-using-constrained-mcmc-change-of-variables" class="level4">
<h4 class="anchored" data-anchor-id="beta-binomial-problem-using-constrained-mcmc-change-of-variables">Beta-Binomial problem using constrained MCMC: Change of variables</h4>
<p>In the Beta-Binomial problem, the parameter of interest is constrained to be within the unit interval, <span class="math inline">\(\pi \in [0,1]\)</span>. Above we sampled <span class="math inline">\(\pi\)</span> from a Beta distribution which automatically fulfilled this constraint. Often it is more convenient to sample from <span class="math inline">\((-\infty, + \infty)\)</span> and transform into the interval <span class="math inline">\([0,1]\)</span>. The transformation needs to be a differentiable function with differentiable inverse (“bijector”).</p>
<p>To transform between <span class="math inline">\(x \in [-\infty, + \infty]\)</span> and <span class="math inline">\(y \in [0,1]\)</span>, we can use the logistic function</p>
<p><span class="math display">\[
y = \sigma(x) = \frac{1}{1 + \exp(-x)}
\]</span></p>
<p>and its inverse</p>
<p><span class="math display">\[
x = \sigma^{-1}(y) = \log \left( \frac{y}{1-y} \right)
\]</span></p>
<p>Conservation of probability mass requires</p>
<p><span class="math display">\[
P_x(x)dx = P_y(y)dy
\]</span></p>
<p><span class="math display">\[
P_x(x)  = P_y(y(x))\frac{dy(x)}{dx} = P_y(\sigma(x))\frac{d \sigma(x)}{dx}
\]</span></p>
<p><span class="math display">\[
\sigma'(x) = \sigma(x) (1 - \sigma(x)) = \sigma(x) \sigma(-x)
\]</span></p>
<p>Instead of drawing <span class="math inline">\(y\)</span> from <span class="math inline">\([0,1]\)</span> we draw <span class="math inline">\(x\)</span> from <span class="math inline">\((-\infty, +\infty)\)</span> using some proposal distribution. In the equation for the acceptance probability, we then replace each occurrence of <span class="math inline">\(P_y(y)\)</span> with <span class="math inline">\(P_x(x) = P_y(y = \sigma(x)) \sigma'(x)\)</span>.</p>
<div id="ba52e767" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># solve Beta-Binomial problem using constrained MCMC</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LogExpFunctions</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">logistic</span>(x) <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu">exp</span>(<span class="op">-</span>x))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">logit</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">log</span>(<span class="cn">π</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> <span class="cn">π</span>))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">logprior</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Beta</span>(<span class="fl">45</span>, <span class="fl">55</span>), <span class="cn">π</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">loglik</span>(<span class="cn">π</span>) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Binomial</span>(<span class="fl">50</span>, <span class="cn">π</span>), <span class="fl">30</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">logjac</span>(x) <span class="op">=</span> <span class="fu">-</span>(<span class="fu">log1pexp</span>(x) <span class="op">+</span> <span class="fu">log1pexp</span>(<span class="op">-</span>x))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># draw Θ ∈ R</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">randproposal</span>(Θ_c) <span class="op">=</span> <span class="fu">rand</span>(<span class="fu">Normal</span>(Θ_c, <span class="fl">0.5</span>))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">logproposal</span>(Θ, Θ_c) <span class="op">=</span> <span class="fu">logpdf</span>(<span class="fu">Normal</span>(Θ_c, <span class="fl">0.5</span>), Θ)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">metropolis_hastings</span>(logprior, loglik, logjac, initial, randproposal, logproposal, n)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> initial</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    samples <span class="op">=</span> [current]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    accepted <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        proposed <span class="op">=</span> <span class="fu">randproposal</span>(current)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        current_ <span class="op">=</span> <span class="fu">logistic</span>(current)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        proposed_ <span class="op">=</span> <span class="fu">logistic</span>(proposed)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        lp_current <span class="op">=</span> <span class="fu">logprior</span>(current_) <span class="op">+</span> <span class="fu">loglik</span>(current_) <span class="op">+</span> <span class="fu">logjac</span>(current) <span class="op">+</span> <span class="fu">logproposal</span>(proposed, current) </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        lp_proposed <span class="op">=</span> <span class="fu">logprior</span>(proposed_) <span class="op">+</span> <span class="fu">loglik</span>(proposed_) <span class="op">+</span> <span class="fu">logjac</span>(proposed) <span class="op">+</span> <span class="fu">logproposal</span>(current, proposed)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        Δ <span class="op">=</span> lp_proposed <span class="op">-</span> lp_current</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Δ <span class="op">&gt;</span> <span class="fl">0.0</span> <span class="op">||</span> <span class="fu">rand</span>() <span class="op">&lt;</span> <span class="fu">exp</span>(Δ)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            current <span class="op">=</span> proposed</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            accepted <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(samples, current)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Acceptance ratio:"</span>, accepted<span class="op">/</span>n)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    samples</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>metropolis_hastings (generic function with 2 methods)</code></pre>
</div>
</div>
<div id="9c188fd9" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> samples2 <span class="op">=</span> <span class="fu">metropolis_hastings</span>(logprior, loglik, logjac, <span class="fl">0.0</span>, randproposal, logproposal, <span class="fl">10_000</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Acceptance ratio:0.365
  0.002972 seconds (45 allocations: 327.914 KiB)</code></pre>
</div>
</div>
<div id="d8749c02" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>samples2 <span class="op">=</span> <span class="fu">logistic</span>.(samples2);</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="fu">Figure</span>(;size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ax1, plt1 <span class="op">=</span> <span class="fu">density</span>(f[<span class="fl">1</span>,<span class="fl">2</span>], samples2; alpha <span class="op">=</span> <span class="fl">0.2</span>, axis <span class="op">=</span> (;title <span class="op">=</span> <span class="st">"Density"</span>, xlabel <span class="op">=</span> <span class="st">"π"</span>, ylabel <span class="op">=</span> <span class="st">"P(π)"</span>), label <span class="op">=</span> <span class="st">"simulation"</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines!</span>(ax1, df.<span class="cn">π</span>, <span class="fu">pdf</span>.(<span class="fu">Beta</span>(<span class="fl">75</span>, <span class="fl">75</span>), df.<span class="cn">π</span>); label <span class="op">=</span> <span class="st">"theoretical"</span>, linewidth <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax1)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>ax2, plt2 <span class="op">=</span> <span class="fu">lines</span>(f[<span class="fl">1</span>,<span class="fl">1</span>], samples2; alpha <span class="op">=</span> <span class="fl">0.4</span>, axis <span class="op">=</span> (;title <span class="op">=</span> <span class="st">"Traceplot"</span>, xlabel <span class="op">=</span> <span class="st">"Samples"</span>, ylabel <span class="op">=</span> <span class="st">"π"</span>))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>┌ Warning: Found `resolution` in the theme when creating a `Scene`. The `resolution` keyword for `Scene`s and `Figure`s has been deprecated. Use `Figure(; size = ...` or `Scene(; size = ...)` instead, which better reflects that this is a unitless size and not a pixel resolution. The key could also come from `set_theme!` calls or related theming functions.
└ @ Makie ~/.julia/packages/Makie/iRM0c/src/scenes.jl:220</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-10-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>see also: https://theoryandpractice.org/stats-ds-book/distributions/change-of-variables.html</p>
</section>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>Gordon2014, ‘Probabilistic programming’ https://dl.acm.org/doi/10.1145/2593882.2593900</p>
<p>BayesRules!</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<p>‘An Introduction to Probabilistic Programming’ https://arxiv.org/pdf/1809.10756</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>